from http.server import BaseHTTPRequestHandler, HTTPServer

from src.module import Module
from src.layout import *
from src.regexs import Regexs
from src.exec import Exec
from src.tasks import Task, Tasks

class ServerTask(Task):
    name = "HTTP Exploit Server"
    
    def __init__(self, html):
        super().__init__()

        class ExploitHandler(BaseHTTPRequestHandler):
            def do_GET(self):
                self.send_response(200)
                self.send_header("Content-type", "text/html")
                self.end_headers()
                self.wfile.write(html.encode("utf-8"))
        
        self.httpd = HTTPServer(("", 1337), ExploitHandler)
    
    def run(self):
        self.httpd.serve_forever()
    
    def cleanup(self):
        self.httpd.shutdown()

class CustomModule(Module):
    name = "HTTP Exploit Server"
    category = "tool"
    layout = [
        Input("Code", "code", textarea=True),
        Submit("Run", "run"),
        Input("Server Output", "output", textarea=True)
    ]
    
    def submit(type, data):
        code = data["code"]

        task = ServerTask(code)
        Tasks.start(task)
        return {"output": "Server started on http://0.0.0.0:1337"}